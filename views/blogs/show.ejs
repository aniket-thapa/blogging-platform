<%- include('../partials/navbar') %>

<div class="container max-w-screen-md mx-auto px-4 py-8">
  <!-- Blog Title -->
  <h1 class="text-5xl font-extrabold text-gray-900 mb-4 tracking-tight">
    <%= blog.title %>
  </h1>

  <!-- Author and Date -->
  <div class="text-sm text-gray-600 mb-6">
    <p>
      By
      <span class="font-medium text-gray-800"><%= blog.author.username %></span>
      on <%= blog.createdAt.toDateString() %> |
      <span id="reading-time">Hello</span>
    </p>
  </div>

  <!-- Blog Content -->
  <div id="blog-content" class="blog-content text-gray-900 text-xl space-y-6">
    <%- blog.content %>
  </div>

  <!-- Horizontal Divider with Icon -->
  <div class="flex items-center justify-center my-8">
    <div class="w-1/3 border-t-2 border-gray-300"></div>
    <span class="mx-4 text-gray-500 font-semibold font-mono">End of Blog</span>
    <div class="w-1/3 border-t-2 border-gray-300"></div>
  </div>

  <!-- Edit and Delete Buttons -->
  <% if (user && blog.author._id.equals(user._id)) { %>
  <div class="mb-6 flex space-x-4">
    <a
      href="/blogs/<%= blog._id %>/edit"
      class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition"
    >
      Edit
    </a>
    <form
      action="/blogs/<%= blog._id %>?_method=DELETE"
      method="POST"
      style="display: inline"
    >
      <button
        type="submit"
        class="bg-red-500 text-white py-2 px-4 rounded hover:bg-red-600 transition"
      >
        Delete
      </button>
    </form>
  </div>
  <% } %>

  <!-- Likes Section -->
  <p class="text-xl mb-6">
    <i class="fa-solid fa-heart text-red-600"></i> <%= blog.likes.length %>
  </p>

  <% if (user && !blog.likes.includes(user._id)) { %>
  <form action="/blogs/<%= blog._id %>/like" method="POST" class="mb-6">
    <button
      type="submit"
      class="bg-green-500 text-white p-2 rounded hover:bg-green-600 transition"
    >
      <i
        class="fa-regular fa-heart"
        onclick="this.classList.remove('fa-regular'); this.classList.add('fa-solid');"
      ></i>
    </button>
  </form>
  <% } %>

  <!-- Comments Section -->
  <h3 class="text-2xl font-bold text-gray-800 mb-4">Comments</h3>
  <div class="space-y-4 mb-6">
    <% blog.comments.forEach(comment => { %>
    <div class="border rounded-lg p-4 bg-gray-50">
      <p class="font-medium text-gray-800"><%= comment.author.username %></p>
      <p class="text-gray-700"><%= comment.content %></p>
      <p class="text-sm text-gray-600">
        Commented on <%= comment.createdAt.toDateString() %>
      </p>
    </div>
    <% }) %>
  </div>

  <% if (user) { %>
  <!-- Add Comment Form -->
  <form
    action="/blogs/<%= blog._id %>/comments"
    method="POST"
    class="space-y-4"
  >
    <textarea
      name="content"
      required
      class="w-full border border-gray-300 rounded p-2 focus:ring-2 focus:ring-blue-500"
      placeholder="Write your comment..."
    ></textarea>
    <button
      type="submit"
      class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition"
    >
      Add Comment
    </button>
  </form>
  <% } %>

  <!-- Copy Link Button -->
  <button
    onclick="navigator.clipboard.writeText('/blogs/<%= blog._id %>')"
    class="mt-6 bg-gray-200 text-gray-800 py-2 px-4 rounded hover:bg-gray-300 transition"
  >
    Copy Link to Blog
  </button>

  <!-- Back to All Blogs -->
  <a href="/blogs" class="block mt-4 text-blue-500 hover:underline">
    Back to All Blogs
  </a>
</div>

<!-- Custom Styling -->
<style>
  .blog-content {
    margin-bottom: 28px;
  }
  .blog-content hr {
    border-color: #a8a8a8;
  }
  .blog-content p {
    margin: 28px 0;
    line-height: 1.75;
  }

  .blog-content h1,
  .blog-content h2,
  .blog-content h3,
  .blog-content h4 {
    margin-top: 32px;
    font-weight: 700;
    line-height: 1.25;
  }

  .blog-content h1 {
    font-size: 2.5rem;
    margin-top: 40px;
    font-weight: 800;
  }

  .blog-content h2 {
    font-size: 2rem;
    margin-top: 40px;
  }

  .blog-content h3 {
    font-size: 1.75rem;
  }

  .blog-content blockquote {
    border-left: 4px solid #4a90e2;
    padding-left: 16px;
    margin: 16px 0;
    font-style: italic;
    color: #4a4a4a;
  }

  .blog-content ul {
    padding-left: 1.5rem;
    list-style-type: disc;
  }

  .blog-content ol {
    padding-left: 1.5rem;
    list-style-type: decimal;
  }

  .blog-content a {
    color: #1e40af;
    text-decoration: underline;
  }

  .blog-content a:hover {
    text-decoration: none;
    color: #2563eb;
  }

  .blog-content code {
    background-color: #f3f4f6;
    padding: 4px 8px;
    border-radius: 4px;
  }

  .blog-content pre {
    background-color: #f3f4f6;
    padding: 16px;
    border-radius: 8px;
    overflow-x: auto;
    font-size: 1rem;
  }
</style>

<script>
  function stripHTML(html) {
    return html.replace(/<[^>]*>/g, '');
  }

  function countWords(text) {
    return text.trim().split(/\s+/).length;
  }

  function calculateReadingTime(content) {
    const plainText = stripHTML(content);
    const wordCount = countWords(plainText);
    const wordsPerMinute = 150;
    return Math.ceil(wordCount / wordsPerMinute);
  }

  document.addEventListener('DOMContentLoaded', () => {
    const blogContent = document.getElementById('blog-content').innerHTML;
    const readingTime = calculateReadingTime(blogContent);
    document.getElementById(
      'reading-time'
    ).textContent = `Reading Time: ${readingTime} minutes`;
  });
</script>
